{% extends "base.html" %}
{% block title %} Contents {% endblock title %}
{% block content %}

    <style>
        label {
            color: LightGray;
        }

        input {
            width: 30px;

        }

        .dataTables_info {
            color: white;
        }

        a {
            color: royalblue;
        }

        p {
            color: black;
        }

        td {
            color: white;
        }
    </style>

    <script type="text/javascript" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css">

    <div class="modal" tabindex="-1" role="dialog" id="modal-form">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="color: black;">Update</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="post-form">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Name
                                        <input type="text" name="name" class="form-control">
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>Subject
                                        <input type="text" name="subject" class="form-control">
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label>Upload Image
                                        <input type="file" name="image" class="form-control">
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Market</label>
                                    <select class="select form-control" name="market">
                                        {% for i in market %}
                                            <option value="{{ i.id }}">{{ i.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Channel</label>
                                    <select class="select form-control" name="channel">
                                        {% for i in channel %}
                                            <option value="{{ i.id }}">{{ i.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Brands</label>
                                    <select class="select form-control" name="brand">
                                        {% for i in brands %}
                                            <option value="{{ i.id }}">{{ i.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary" id='submitButton'>Update Content</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row" id="list-cards">
    </div>

    <script>

        csrftoken = '{{ csrf_token }}'

        function deleteItem(item) {
            console.log('Delete clicked' + item)
            $.ajax({
                method: 'DELETE',
                url: 'api/content/' + item + '/',
                headers: {
                    'Content-type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                success: function () {
                    swal.fire('Deleted!');
                    window.location.reload();
                }
            })
        }

        function editBrand(item) {
            $('#post-form').submit(function (e) {
                var formData = new FormData(e.target);
                e.preventDefault();
                $.ajax({
                    url: 'api/content/' + item + '/',
                    type: "PATCH",
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {'X-CSRFToken': csrftoken},
                    mimeType: "multipart/form-data",
                    success: function () {
                        swal.fire("Updated!");
                        setTimeout(function () {
                            window.location.href = "content-list"
                        }, 2000);
                    }
                });
            })
        }

        var myArray = []

        $.ajax({
            method: 'GET',
            url: 'api/content/',
            success: function (response) {
                myArray = response
                buildTable(myArray)
            }
        })

        function buildTable(data) {
            var table = document.getElementById('list-cards')
            for (i in data) {
                {# JSON.stringify to convert object object to json format then covert it to dict #}
                channel_dict = JSON.stringify(data[i]['channel'])
                marketplace_dict = JSON.stringify(data[i]['marketplace'])
                brands_dict = JSON.stringify(data[i]['brands'])
                try {
                    channel_dict_name = JSON.parse(channel_dict).name
                } catch (err) {
                    channel_dict_name = "No channel"
                }
                try {
                    marketplace_dict_img = JSON.parse(marketplace_dict).logo
                    marketplace_dict_name = JSON.parse(marketplace_dict).name
                } catch (err) {
                    marketplace_dict_img = "No market Image"
                    marketplace_dict_name = "No market name"
                }
                try {
                    brands_dict_img = JSON.parse(brands_dict).image
                } catch (err) {
                    brands_dict_img = "No market Image"
                }
                var row = `<div class="card">
                               <div class="card-body">
                                   <img class="card-img-bottom two" src="${data[i].image}" alt="No image" style="width: 30rem;" >
                                   <img class="card-img-bottom two" src="${marketplace_dict_img}" alt="No market Image" style="width: 10rem;" >
                                   <img class="card-img-bottom two" src="${brands_dict_img}" alt="No Brand Image" style="width: 10rem;" >
                                   <h5 class="card-title" style="color: black">${data[i].name}</h5>
                                   <p class="card-text"><span><b>Content</b></span></p>
                                   <p class="card-text">${data[i].subject}</p>
                                   <p class="card-text"><span><b>Channel Name: </b></span> ${channel_dict_name}</p>
                                   <p class="card-text"><span><b>Market Name: </b></span> ${marketplace_dict_name}</p>
                               </div>
                               <div>
                                   <button class="btn btn-danger" onclick="deleteItem(${data[i].id})">Delete</button>
                                   </button>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-form"
                                        onclick="editBrand(${data[i].id})">Edit</button>
                               </div>
                           </div>`

                table.innerHTML += row
            }
        }
    </script>

    <script>
        $(document).ready(function () {
            $('#example').DataTable();
        });
    </script>

{% endblock %}